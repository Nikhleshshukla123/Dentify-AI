{% extends 'home/master.html' %}
{% load static %}
{% block title %}
<title>Dentify AI - Revolutionizing Dentists</title>
{% endblock %}

{% block body %}

{% if messages %}
<section class="messages absolute w-[100%]" style="z-index: 5;">
  {% for message in messages %}
  <div
    class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show"
    role="alert">
    <strong>{{ message.tags|capfirst }} :</strong> {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"
      onclick="this.parentNode.remove(true)"></button>
  </div>
  {% endfor %}
</section>

<div id="alert-area" class="relative m-0"></div>
{% endif %}
<div class="container items-center justify-center px-4 py-8 bg-[white] rounded-lg shadow-md max-h-fit aspect-[15/12]">
  <div class="mb-8">
    <h2 class="text-2xl font-bold mb-4">Upload X-ray for Prediction</h2>
    <label id="dropzone" for="fileInput" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);"
      class="w-full min-h-[250px] flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition duration-300">
      <p class="text-gray-600 mb-2">Drag and drop your X-ray image here</p>
      <p class="text-sm text-gray-500">or</p>
      <label for="fileInput"
        class="mt-2 inline-block bg-blue-500 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-600 transition duration-300">
        Select File
      </label>
    </label>
    <input id="fileInput" type="file" hidden accept="image/*" onchange="handleFileSelect(this.files)">
    <div id="imagePreview-section" class="hidden bg-gray-100 mt-4 flex items-center p-4 rounded-lg justify-between">
      <div class="block border border-gray-800 rounded-lg">
        <img id="imagePreview" class="w-[75px] h-[75px] rounded-lg object-fill">
      </div>
      <p id="fileName" class="text-[14px] text-gray-600 font-bold"></p>
      <button id="predictButton" onclick="predictImage()"
        class="bg-green-500 text-white px-4 py-2 rounded cursor-pointer hover:bg-green-600 transition duration-300">
        Predict
      </button>
    </div>
  </div>
</div>

<div class="container p-0">
  <div class="overflow-x-hidden shadow-md rounded-lg box-border bg-[white]">
    <h2 class="text-2xl font-bold p-[25px]" style="border-bottom: 2px solid lightgrey;">Prediction History</h2>
    <div class="flex flex-col sm:flex-row justify-between items-center p-4 bg-[white] border-b">
      <input type="text" id="search" placeholder="Search by Result"
        class="mb-2 sm:mb-0 px-3 py-1 w-full sm:w-64 bg-gray-50 border rounded-md focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
        onkeyup="searchTable()">
      <div class="flex items-center space-x-2 text-sm">
        <button
          class="px-3 py-1 bg-gray-200 text-gray-600 rounded hover:bg-gray-300 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"
          {% if not previous_page %}disabled{% endif %}>Prev</button>
        <span class="text-gray-700">Page {{ current_page }}/{{ total_pages }}</span>
        <button
          class="px-3 py-1 bg-gray-200 text-gray-600 rounded hover:bg-gray-300 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"
          {% if not next_page %}disabled{% endif %}>Next</button>
      </div>
    </div>
    <table class="w-full text-xs text-left text-gray-500">
      <thead class="text-xs text-gray-700 uppercase bg-gray-100">
        <tr>
          <th scope="col" class="px-4 py-2">#</th>
          <th scope="col" class="px-4 py-2">Image</th>
          <th scope="col" class="px-4 py-2">Date</th>
          <th scope="col" class="px-4 py-2">Result</th>
          <th scope="col" class="px-4 py-2">Confidence</th>
          <th scope="col" class="px-4 py-2">Message</th>
        </tr>
      </thead>
      <tbody>
        {% for prediction in history %}
        <tr class="bg-[white] border-ber:bg-gray-50">
          <td class="px-4 py-2">{{ forloop.counter }}</td>
          <td class="px-4 py-2">
            <img src="{{ prediction.xray_file.url }}" alt="Prediction" class="w-16 h-16 object-cover rounded shadow-sm">
          </td>
          <td class="px-4 py-2">{{ prediction.pred_ts|date:"M d, Y H:i" }}</td>
          <td class="px-4 py-2">{{ prediction.result }}</td>
          <td class="px-4 py-2">{{ prediction.confidence|floatformat:2 }}%</td>
          <td class="px-4 py-2">{{ prediction.message|truncatechars:30 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endblock %}

  {% block script %}
  <script>

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const imagePreviewSection = document.getElementById('imagePreview-section');
    const imagePreview = document.getElementById('imagePreview');
    const fileName = document.getElementById('fileName');
    let xray_file = null;
    async function handleFileSelect(files) {
      if (files.length > 0) {
        image = URL.createObjectURL(files[0])
        imagePreview.src = image;
        name = files[0].name.slice(0, 10) + ' *.' + (files[0].name).split('.').pop();
        fileName.textContent = name;
        imagePreviewSection.style.display = 'flex';
        xray_file = files[0];
      }
      else {
        imagePreviewSection.style.display = 'none';
        xray_file = null;
      }
    }
    async function predictImage() {
      const formData = new FormData();
      formData.append('xray_file', xray_file);

      try {
        const response = await fetch('{% url "predict" %}', {
          method: 'POST',
          body: formData,
        });

        if (response.ok) {
          const result = await response.json(); // Assuming the response is JSON
          alert('Prediction successful');
          console.log(result);
          // Handle the prediction response
        } else {
          const errorData = await response.json();
          alert('Prediction failed: ' + errorData.error);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function dropHandler(e) {
      e.preventDefault();
      const data = e.dataTransfer;
      console.log(e.dataTransfer.files, data);
      if (e.dataTransfer.items) {
        for (const item of e.dataTransfer.items) {
          if (item.kind === 'file') {
            const file = item.getAsFile();
            handleFileSelect([file]);
          }
        }
      } else {
        for (const file of e.dataTransfer.files) {
          handleFileSelect([file]);
        }
      }
    }

    function dragOverHandler(e) {
      e.preventDefault();
    }

    function searchTable() {
      var input, filter, table, tr, td, i, txtValue;
      input = document.getElementById("search");
      filter = input.value.trim().toLowerCase();
      table = document.querySelector("table");
      tr = table.getElementsByTagName("tr");
      for (i = 0; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[3]; // Index 3 corresponds to the "Result" column
        if (td) {
          txtValue = td.textContent || td.innerText;
          if (txtValue.toLowerCase().includes(filter)) {
            tr[i].style.display = "";
            td.style.backgroundColor = "yellow";
            setTimeout((td) => {
              td.style.backgroundColor = "";
            }, 100, td);
          } else {
            tr[i].style.display = "none";
            td.style.backgroundColor = "";
          }
        }
      }
    }
  </script>
  {% endblock %}